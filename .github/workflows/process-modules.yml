name: Process Module Zips

on:
  push:
    paths:
      - 'modules-zips/**/*.zip'
    branches: [main]

permissions:
  contents: write

jobs:
  extract-modules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Extract and organize modules
        run: |
          # Create public/modules directory if it doesn't exist
          mkdir -p public/modules
          
          # Process each zip file
          for zipfile in modules-zips/*.zip; do
            if [ -f "$zipfile" ]; then
              # Get module name (filename without .zip)
              modulename=$(basename "$zipfile" .zip)
              echo "Processing module: $modulename"
              
              # Create temp directory for extraction
              tempdir="temp_$modulename"
              mkdir -p "$tempdir"
              
              # Extract zip to temp directory
              unzip -o "$zipfile" -d "$tempdir"
              
              # Check if package.json exists (needs building)
              if [ -f "$tempdir/package.json" ]; then
                echo "Building $modulename..."
                
                # Fix common JSX syntax errors in App.tsx before building
                if [ -f "$tempdir/App.tsx" ]; then
                  # Fix arrow operators -> to {'->'} 
                  sed -i "s/ -> / {'->'} /g" "$tempdir/App.tsx"
                  # Fix double arrows >> to {'>>'}
                  sed -i 's/">>/{">>"}/g' "$tempdir/App.tsx"
                  # Fix standalone > in text to {'>'}
                  sed -i 's/(\([^<>]*\)>\([0-9]\)/({\1{">"}\2}/g' "$tempdir/App.tsx"
                  # Fix HTML entities - replace &lt; and &gt; with {"<"} and {">"}
                  sed -i 's/&lt;/{'"'"'<'"'"'}/g' "$tempdir/App.tsx"
                  sed -i 's/&gt;/{'"'"'>'"'"'}/g' "$tempdir/App.tsx"
                  echo "Fixed JSX syntax errors in App.tsx"
                fi
                
                cd "$tempdir"
                npm install
                npm run build
                cd ..
                
                # Copy built files to public/modules
                mkdir -p "public/modules/$modulename"
                cp -r "$tempdir/dist/"* "public/modules/$modulename/"
                
                # Cleanup temp directory
                rm -rf "$tempdir"
              else
                # No build needed, just copy
                mkdir -p "public/modules/$modulename"
                cp -r "$tempdir/"* "public/modules/$modulename/"
                rm -rf "$tempdir"
              fi
              
              echo "Processed $modulename"
            fi
          done
      
      - name: Update modules registry
        run: |
          # Create or update modules.json
          echo "{" > modules.json
          first=true
          for moduledir in public/modules/*; do
            if [ -d "$moduledir" ]; then
              modulename=$(basename "$moduledir")
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> modules.json
              fi
              echo "  \"$modulename\": \"/Psych-hub/modules/$modulename/index.html\"" >> modules.json
            fi
          done
          echo "" >> modules.json
          echo "}" >> modules.json
          
          echo "Updated modules.json:"
          cat modules.json
      
      - name: Commit extracted modules
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/modules modules.json
          git diff --staged --quiet || git commit -m "Auto-extract modules from zips"
          git push
